"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[197],{3197:function(e,t,r){r.r(t),r.d(t,{default:function(){return u}});var n=r(7437),s=r(2265),l=r(1907),a=r(728),o=e=>{let{type:t,content:r,isBot:s}=e;return(0,n.jsx)("div",{className:"max-w-3/4 ".concat(s?"ml-0 mr-auto":"ml-auto mr-0"),children:(0,n.jsx)("div",{className:"p-3 rounded-lg ".concat(s?"bg-gray-200":"bg-blue-500 text-white"," max-h-[80vh] overflow-y-auto"),children:(()=>{if("object"==typeof r)return(0,n.jsx)(l.Z,{language:"json",style:a.Z,children:JSON.stringify(r,null,2)});if("string"==typeof r){let e=r.replace(/^```(json|python)?\s*|\s*```$/g,"");try{let t=JSON.parse(e);return(0,n.jsx)(l.Z,{language:"json",style:a.Z,children:JSON.stringify(t,null,2)})}catch(e){}return e.includes("def ")||e.includes("import ")||e.includes("print(")?(0,n.jsx)(l.Z,{language:"python",style:a.Z,children:e}):e.split(/(\!\[.*?\]\(.*?\)|\[.*?\]\(.*?\))/).map((e,t)=>{if(e.startsWith("![")){let r=e.match(/\!\[(.*?)\]\((.*?)\)/);if(r)return(0,n.jsx)("img",{src:r[2],alt:r[1],className:"max-w-full h-auto my-2"},t)}else if(e.startsWith("[")){let r=e.match(/\[(.*?)\]\((.*?)\)/);if(r)return(0,n.jsx)("a",{href:r[2],target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 hover:underline",children:r[1]},t)}return(0,n.jsx)("span",{children:e},t)})}return(0,n.jsx)("p",{className:"break-words whitespace-pre-wrap",children:String(r)})})()})})},c=e=>{let{onSendMessage:t,disabled:r}=e,[l,a]=(0,s.useState)(""),o=(0,s.useRef)(null);(0,s.useEffect)(()=>{o.current&&(o.current.style.height="auto",o.current.style.height="".concat(Math.min(o.current.scrollHeight,150),"px"))},[l]);let c=e=>{e.preventDefault(),l.trim()&&!r&&(t(l),a(""))};return(0,n.jsxs)("form",{onSubmit:c,className:"flex items-end",children:[(0,n.jsx)("textarea",{ref:o,value:l,onChange:e=>a(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),c(e))},className:"flex-grow p-2 border rounded-l resize-none overflow-hidden",placeholder:"Type your message...",disabled:r,rows:1,style:{maxHeight:"150px"}}),(0,n.jsx)("button",{type:"submit",className:"p-2 bg-blue-500 text-white rounded-r h-full",disabled:r,children:"Send"})]})},i=r(2800),u=e=>{let{chatHistory:t}=e,[r,l]=(0,s.useState)(t),[a,u]=(0,s.useState)(!1),[d,h]=(0,s.useState)(null),f=(0,s.useRef)(null),p=(0,s.useRef)(null),m=(0,s.useRef)(null),y=(0,s.useRef)(null);(0,s.useEffect)(()=>{var e;null===(e=m.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[r]),(0,s.useEffect)(()=>{(async()=>{h(await (0,i.MQ)())})()},[]);let x=(0,s.useCallback)(async e=>{l(t=>[...t,{type:"text",content:e,isBot:!1}]),u(!0),f.current=null,p.current=null;try{let t=await fetch("/api/schat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:d,message:e})});if(!t.ok)throw Error("Network response was not ok");let{session_id:r}=await t.json();y.current&&y.current.close();let n=new EventSource("/api/chat-stream?session_id=".concat(r));y.current=n,n.onmessage=e=>{if("[DONE]"===e.data){u(!1),n.close();return}try{let t=JSON.parse(e.data);if("error"===t.type){console.error("Error: ".concat(t.content));return}p.current===t.type?(f.current+=t.content,l(e=>{let t=[...e];return t[t.length-1].content=f.current,t})):(f.current=t.content,p.current=t.type,l(e=>[...e,{type:t.type,content:t.content,isBot:!0}]))}catch(e){console.error("Error parsing SSE data:",e)}},n.onerror=e=>{console.error("EventSource failed:",e),n.close(),u(!1)}}catch(e){console.error("Error sending message:",e),l(e=>[...e,{type:"text",content:"Error: Unable to get response from the server.",isBot:!0}]),u(!1)}},[d]);return(0,n.jsxs)("div",{className:"flex flex-col h-full max-h-full",children:[(0,n.jsxs)("div",{className:"flex-grow overflow-y-auto p-4 space-y-4",children:[r.map((e,t)=>(0,n.jsx)(o,{type:e.type,content:e.content,isBot:e.isBot},t)),a&&(0,n.jsx)("p",{className:"italic text-gray-500",children:"\uD83E\uDD16在努力思考。。。"}),(0,n.jsx)("div",{ref:m})]}),(0,n.jsx)("div",{className:"flex-shrink-0 p-4 border-t",children:(0,n.jsx)(c,{onSendMessage:x,disabled:a})})]})}}}]);